<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>RecordRoute File Upload</title>
</head>
<body>
    <h1>Upload File</h1>
    <input type="file" id="fileInput" accept="audio/*,.md,.txt,.text,.markdown" />
    <button id="uploadBtn">Upload</button>
    <div id="status"></div>

    <div id="workflow" style="display:none; margin-top:1em;">
        <label><input type="checkbox" id="stepStt" /> STT 변환</label>
        <label><input type="checkbox" id="stepCorrect" /> 텍스트 교정</label>
        <label><input type="checkbox" id="stepSummary" /> 요약</label>
        <button id="processBtn">확인</button>
    </div>

    <div id="downloads" style="margin-top:1em;"></div>

    <script>
        let uploadedPath = null;
        let fileType = null;

        function updateWorkflowOptions(fileType) {
            const sttCheckbox = document.getElementById('stepStt');
            const sttLabel = sttCheckbox.parentElement;
            
            if (fileType === 'audio') {
                // Show all checkboxes for audio files
                sttLabel.style.display = 'block';
                sttLabel.style.visibility = 'visible';
                sttCheckbox.checked = false;
                sttCheckbox.disabled = false;
            } else if (fileType === 'text') {
                // Hide STT checkbox for text files
                sttLabel.style.display = 'none';
                sttLabel.style.visibility = 'hidden';
                sttCheckbox.checked = false;
                sttCheckbox.disabled = true;
            } else {
                // For unknown types, show all options
                sttLabel.style.display = 'block';
                sttLabel.style.visibility = 'visible';
                sttCheckbox.checked = false;
                sttCheckbox.disabled = false;
            }
            
            // Reset other checkboxes
            document.getElementById('stepCorrect').checked = false;
            document.getElementById('stepSummary').checked = false;
        }

        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const input = document.getElementById('fileInput');
            const status = document.getElementById('status');
            if (!input.files.length) {
                status.textContent = 'Please select a file first.';
                return;
            }
            const formData = new FormData();
            formData.append('file', input.files[0]);
            try {
                const resp = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                if (resp.ok) {
                    const data = await resp.json();
                    uploadedPath = data.file_path;
                    fileType = data.file_type;
                    
                    updateWorkflowOptions(fileType);
                    document.getElementById('workflow').style.display = 'block';
                    
                    if (fileType === 'audio') {
                        status.textContent = 'Upload complete! Select workflow steps.';
                    } else if (fileType === 'text') {
                        status.textContent = 'Upload complete! Select text processing steps.';
                    } else {
                        status.textContent = 'Upload complete! File type not fully supported, but you can try processing.';
                    }
                } else {
                    status.textContent = 'Upload failed.';
                }
            } catch (err) {
                status.textContent = 'Error: ' + err.message;
            }
        });

        document.getElementById('processBtn').addEventListener('click', async () => {
            if (!uploadedPath) return;

            const steps = [];
            if (document.getElementById('stepStt').checked) steps.push('stt');
            if (document.getElementById('stepCorrect').checked) steps.push('correct');
            if (document.getElementById('stepSummary').checked) steps.push('summary');

            if (steps.length === 0) {
                alert('최소 하나의 작업을 선택해주세요.');
                return;
            }

            const downloads = document.getElementById('downloads');
            downloads.innerHTML = '<p style="color: blue; font-weight: bold;">작업을 시작합니다...</p>';

            const resp = await fetch('/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: uploadedPath, steps })
            });

            downloads.innerHTML = '';

            if (!resp.ok) {
                downloads.innerHTML = '<p style="color: red;">작업 처리에 실패했습니다.</p>';
                return;
            }

            const result = await resp.json();

            if (result.error) {
                downloads.innerHTML = `<p style="color: red;">오류: ${result.error}</p>`;
                return;
            }

            let hasResults = false;
            ['stt', 'correct', 'summary'].forEach(step => {
                if (result[step]) {
                    hasResults = true;
                    const link = document.createElement('a');
                    link.href = result[step];
                    link.textContent = step.toUpperCase() + ' 파일 다운로드';
                    link.download = '';
                    link.style.display = 'block';
                    link.style.marginBottom = '10px';
                    link.style.padding = '8px 12px';
                    link.style.backgroundColor = '#007bff';
                    link.style.color = 'white';
                    link.style.textDecoration = 'none';
                    link.style.borderRadius = '4px';
                    downloads.appendChild(link);
                }
            });

            if (!hasResults) {
                downloads.innerHTML = '<p style="color: orange;">처리는 완료되었지만 다운로드할 파일이 없습니다.</p>';
            }
        });
    </script>
</body>
</html>
